terraform {
  required_providers {
    proxmox = {
      source  = "bpg/proxmox"
      version = "~> 0.70"
    }
  }
}

# Fixed BPG provider configuration based on research
provider "proxmox" {
  endpoint  = "https://10.10.1.21:8006/"
  
  # Use root@pam with password for maximum compatibility
  username = "root@pam"
  password = "your-root-password"  # Replace with actual password
  insecure = true
  
  # SSH configuration - required for some operations
  ssh {
    agent                = false
    username             = "root"
    private_key          = file("~/.ssh/id_rsa")  # Ensure this exists
    node {
      name    = "node1"
      address = "10.10.1.21"
    }
  }
  
  # Timeouts to handle slow operations
  tmp_dir = "/var/tmp"
}

# Minimal viable VM - avoid all complex features
resource "proxmox_virtual_environment_vm" "minimal_test" {
  name        = "minimal-k8s-test"
  description = "Minimal test VM to verify Terraform works"
  node_name   = "node1"
  vm_id       = 152
  
  # Clone configuration
  clone {
    vm_id   = 9003  # Our golden template
    full    = true
    retries = 3
  }
  
  # Minimal resources
  cpu {
    cores = 2
  }
  
  memory {
    dedicated = 2048
  }
  
  # Single network interface - no complex config
  network_device {
    bridge = "vmbr0"
    model  = "virtio"
  }
  
  # Enable agent for basic functionality
  agent {
    enabled = true
    timeout = "30m"  # Increased timeout
  }
  
  # Don't start immediately - let's verify creation first
  started = false
  
  # Prevent destruction of working VMs
  lifecycle {
    prevent_destroy = false  # Set to true once working
  }
}

# Outputs for verification
output "minimal_vm" {
  value = {
    id         = proxmox_virtual_environment_vm.minimal_test.id
    name       = proxmox_virtual_environment_vm.minimal_test.name
    vm_id      = proxmox_virtual_environment_vm.minimal_test.vm_id
    node_name  = proxmox_virtual_environment_vm.minimal_test.node_name
  }
}