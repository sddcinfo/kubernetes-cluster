# /etc/dnsmasq.d/kubernetes.conf
# Kubernetes Cluster DNS and DHCP Configuration
# This file coexists with provisioning.conf for base infrastructure

# === Kubernetes Control Plane ===
# Virtual IP for HA control plane access
host-record=k8s-vip.sddc.info,10.10.1.30
host-record=k8s-vip,10.10.1.30
ptr-record=30.1.10.10.in-addr.arpa,k8s-vip.sddc.info

# Control plane node 1
host-record=k8s-control-1.sddc.info,10.10.1.31
host-record=k8s-control-1,10.10.1.31
ptr-record=31.1.10.10.in-addr.arpa,k8s-control-1.sddc.info

# Control plane node 2
host-record=k8s-control-2.sddc.info,10.10.1.32
host-record=k8s-control-2,10.10.1.32
ptr-record=32.1.10.10.in-addr.arpa,k8s-control-2.sddc.info

# Control plane node 3
host-record=k8s-control-3.sddc.info,10.10.1.33
host-record=k8s-control-3,10.10.1.33
ptr-record=33.1.10.10.in-addr.arpa,k8s-control-3.sddc.info

# === Kubernetes Worker Nodes ===
# Worker node 1
host-record=k8s-worker-1.sddc.info,10.10.1.40
host-record=k8s-worker-1,10.10.1.40
ptr-record=40.1.10.10.in-addr.arpa,k8s-worker-1.sddc.info

# Worker node 2
host-record=k8s-worker-2.sddc.info,10.10.1.41
host-record=k8s-worker-2,10.10.1.41
ptr-record=41.1.10.10.in-addr.arpa,k8s-worker-2.sddc.info

# Worker node 3
host-record=k8s-worker-3.sddc.info,10.10.1.42
host-record=k8s-worker-3,10.10.1.42
ptr-record=42.1.10.10.in-addr.arpa,k8s-worker-3.sddc.info

# Worker node 4
host-record=k8s-worker-4.sddc.info,10.10.1.43
host-record=k8s-worker-4,10.10.1.43
ptr-record=43.1.10.10.in-addr.arpa,k8s-worker-4.sddc.info

# === Kubernetes Service Endpoints ===
# These will be managed by MetalLB but we define DNS for common services
# Ingress controller
host-record=ingress.k8s.sddc.info,10.10.1.50
ptr-record=50.1.10.10.in-addr.arpa,ingress.k8s.sddc.info

# Monitoring stack
host-record=prometheus.k8s.sddc.info,10.10.1.51
ptr-record=51.1.10.10.in-addr.arpa,prometheus.k8s.sddc.info

host-record=grafana.k8s.sddc.info,10.10.1.52
ptr-record=52.1.10.10.in-addr.arpa,grafana.k8s.sddc.info

# Container registry
host-record=registry.k8s.sddc.info,10.10.1.53
ptr-record=53.1.10.10.in-addr.arpa,registry.k8s.sddc.info

# === CNAME Aliases for Services ===
# User-friendly aliases for common services
cname=k8s-api.sddc.info,k8s-vip.sddc.info
cname=kubernetes.sddc.info,k8s-vip.sddc.info
cname=dashboard.k8s.sddc.info,ingress.k8s.sddc.info
cname=metrics.k8s.sddc.info,grafana.k8s.sddc.info

# === SRV Records for Kubernetes API Discovery ===
# Kubernetes API server discovery
srv-host=_kubernetes._tcp.sddc.info,k8s-vip.sddc.info,6443,0,100

# === Additional DNS Options for Kubernetes ===
# Ensure cluster DNS queries are handled properly
# This helps with service discovery within the cluster
# Note: These are informational - actual cluster DNS is handled by CoreDNS
# but external queries for cluster services will resolve correctly

# === Wildcard for Ingress ===
# Wildcard DNS for applications exposed via ingress
# All *.apps.sddc.info will resolve to the ingress controller
address=/apps.sddc.info/10.10.1.60

# === Notes ===
# 1. VMs created by OpenTofu/Terraform will get IPs via cloud-init
# 2. MACs will be generated dynamically, so no DHCP reservations here
# 3. MetalLB will manage IPs in the 10.10.1.50-79 range
# 4. This file can be copied to /etc/dnsmasq.d/ on the dnsmasq server
# 5. After copying, reload dnsmasq: systemctl reload dnsmasq